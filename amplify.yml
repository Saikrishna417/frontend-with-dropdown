version: 1
frontend:
  phases:
    preBuild:
      commands:
        - corepack enable || true
        - corepack prepare pnpm@latest --activate || npm i -g pnpm@latest
        - export PNPM_STORE_DIR="./.pnpm-store" # Explicitly set a local store path
        - pnpm install
    build:
      commands:
        - echo "Using LIVEKIT_URL=$LIVEKIT_URL"
        - echo "Using LIVEKIT_API_KEY=$LIVEKIT_API_KEY"
        - echo "Using LIVEKIT_API_SECRET=$LIVEKIT_API_SECRET"
        - pnpm build # runs `next build`
    postBuild:
      commands:
        - echo "Listing build output for debugging"
        - ls -la .next || true
        - ls -la .next/static || true
  artifacts:
    # For SSR Next apps Amplify expects .next as the base directory
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - ./.pnpm-store/**/* # Cache the local store directory